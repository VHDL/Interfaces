name: Regression Testing

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 15 * * *'

jobs:
  Variables:
    name: ðŸ’» Pipeline variables
    runs-on: ubuntu-24.04
    outputs:
      branch: ${{ steps.Variables.outputs.branch }}
      tag:    ${{ steps.Variables.outputs.tag }}
    steps:
      - name: ðŸ’» Compute pipeline variables
        id: Variables
        run: |
          ref="${{ github.ref }}"

          branch=""
          tag=""
          if [[ "${{ startsWith(github.ref, 'refs/heads/') }}" == "true" ]]; then
            branch="${ref:11}"
          elif [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            tag="${ref:10}"
          elif [[ "${{ startsWith(github.ref, 'refs/pull/') }}" == "true" ]]; then
            printf "Detected a pull request.\n"
          else
            printf "::error title=%s::%s\n" "Variables" "Unsupported Git reference format: '${ref}'."
            exit 1
          fi

          tee "${GITHUB_OUTPUT}" <<EOF
          branch=${branch}
          tag=${tag}
          EOF

  NVC:
    name: ${{ matrix.icon }}${{ matrix.name }} - NVC
    runs-on: ${{ matrix.image }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - {icon: "ðŸ§",   name: "Ubuntu",  image: "ubuntu-24.04", shell: "bash"}
          - {icon: "ðŸªŸ",   name: "Windows", image: "windows-2022", shell: "powershell"}
          - {icon: "ðŸªŸðŸŸ¨", name: "Windows", image: "windows-2022", shell: "msys2 {0}"}       # Installation in Windows via MSI, but called from UCRT64.

    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
      - name: â¬ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ${{ matrix.icon }} Setup MSYS2 for UCRT64
        uses: msys2/setup-msys2@v2
        if: matrix.name == 'Windows' && startsWith(matrix.shell, 'msys2')
        with:
          msystem: ucrt64
          update: true
          install: git tree
          pacboy: tcl:p tcllib:p

      - name: ðŸ§ðŸ› ï¸ Install tcl and tcllib
        if: matrix.name == 'Ubuntu'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends tcl tcllib

      - name: ðŸ”§ Install NVC
        uses: nickg/setup-nvc-ci@v1
        with:
          version: latest

      - name: ðŸš§ Run tests on Ubuntu
        if: matrix.name == 'Ubuntu'
        run: |
          mkdir -p temp
          cd temp

          ../scripts/NVC.tcl

      - name: ðŸš§ Run tests on Windows + MSYS2/UCRT64
        if: matrix.name == 'Windows' && startsWith(matrix.shell, 'msys2')
        run: |
          export PATH="/c/Program Files/NVC/bin:$PATH"

          mkdir -p temp
          cd temp

          ../scripts/NVC.tcl
